<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../cube-resource/cube-resource.html">

<dom-module id="cube-repeat" attributes="template-url items-url items auth">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <cube-resource auto="[[itemsUrl]]" url="[[itemsUrl]]" data="{{items}}"></cube-resource>

        <cube-resource auto="[[templateUrl]]" url="[[templateUrl]]"
                       data="{{_pendingTpl}}" status="{{_status}}"></cube-resource>

        <dom-repeat id="rep" items="[[data]]"></dom-repeat>

        <template id="cont"></template>
        <slot id="content"></slot>
    </template>


    <script>
      /**
       * `cube-repeat`
       * Repeat a provided template using a provided dataset
       *
       * @customElement
       * @polymer
       * @demo demo/index.html
       */
      class CubeRepeat extends Polymer.DomRepeat {
        static get is() {
          return 'cube-repeat';
        }

        static get properties() {
          return {
            items: {
              type: Array, value: function() {
                return [];
              },
            },
            itemsUrl: {type: String, value: '', observer: '_itemsUrlChanged'},
            templateUrl: {type: String, value: '', observer: '_templateUrlChanged'},
            auth: {type: Boolean, value: false},
          };
        }

        _itemsUrlChanged(url) {
          if (url) {
            let self = this;
            this._sendRequest(
                url,
                function() {
                  if (this.readyState === XMLHttpRequest.DONE) {
                    self.items = JSON.parse(this.responseText);
                  }
                },
            );
          }
        }

        _templateUrlChanged(url) {
          if (url) {
            let self = this;
            this._sendRequest(
                url,
                function() {
                  if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    let tpl = document.createElement('template');
                    tpl.innerHTML = this.responseText;
                    self.__replaceTemplate(tpl);
                  }
                },
            );
          }
        }

        _sendRequest(url, callback) {
          let xhr = new XMLHttpRequest();
          xhr.addEventListener('readystatechange', callback);
          xhr.open('GET', url);
          xhr.withCredentials = Boolean(this.auth);
          xhr.send();
        }

        __replaceTemplate(template) {
          this.__resetRepeat();
          this.textContent = '';
          this.appendChild(template);
          this.render();
        }

        __resetRepeat() { // remove old instances
          for (let instanceIdx in this.__instances) {
            if (this.__instances.hasOwnProperty(instanceIdx)) {
              for (let nodeIdx in this.__instances[instanceIdx].children) {
                if (this.__instances[instanceIdx].children.hasOwnProperty(nodeIdx)) {
                  this.parentNode.removeChild(this.__instances[instanceIdx].children[nodeIdx]);
                }
              }
            }
          }

          this.__instances = [];
          this.__pool = [];
          this.__renderDebouncer = null;
          this.__itemsIdxToInstIdx = {};
          this.__chunkCount = null;
          this.__lastChunkTime = null;
          this.__needFullRefresh = false;
          this.__sortFn = null;
          this.__filterFn = null;
          this.__observePaths = null;
          this.__ctor = null;
        }
      }

      window.customElements.define(CubeRepeat.is, CubeRepeat);
    </script>
</dom-module>
